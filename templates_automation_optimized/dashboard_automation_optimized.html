
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªåŠ¨åŒ–é€‰å“åˆ†æç³»ç»Ÿ - ä¼˜åŒ–ç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft YaHei', Arial, sans-serif; 
            background: #f5f6fa;
            min-height: 100vh;
        }
        .container { 
            max-width: 1600px; 
            margin: 0 auto; 
        }
        .header { 
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { 
            font-size: 2.5em; 
            margin-bottom: 5px;
        }
        .header p {
            opacity: 0.9;
        }
        .user-info {
            text-align: right;
        }
        .user-info a {
            color: white;
            text-decoration: none;
            margin-left: 15px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 5px;
        }
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin: 20px 40px;
        }
        .automation-panel {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .stats-panel {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 15px;
        }
        .automation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        .automation-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border-left: 6px solid #3498db;
            transition: all 0.3s ease;
        }
        .automation-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .card-icon {
            font-size: 2em;
            margin-right: 15px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card.warning {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        .stat-card.success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        .reports-section {
            margin-top: 30px;
        }
        .report-item {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .system-status {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .status-item {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
        }
        .task-list {
            margin-top: 20px;
        }
        .task-item {
            background: #34495e;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>ğŸ¤– è‡ªåŠ¨åŒ–é€‰å“åˆ†æç³»ç»Ÿ - ä¼˜åŒ–ç‰ˆ</h1>
                <p>æ™ºèƒ½æŠ¥å‘Š Â· å®šæ—¶ä»»åŠ¡ Â· é‚®ä»¶é€šçŸ¥ Â· å®æ—¶ç›‘æ§</p>
            </div>
            <div class="user-info">
                æ¬¢è¿, <strong>{{ username }}</strong>! 
                <a href="{{ url_for('logout') }}">é€€å‡ºç™»å½•</a>
            </div>
        </div>

        <div class="main-content">
            <div class="automation-panel">
                <div class="panel-header">
                    <h2>ğŸ”„ è‡ªåŠ¨åŒ–ä»»åŠ¡æ§åˆ¶</h2>
                    <div>
                        <button class="btn btn-success" onclick="generateReport()">ğŸ“Š ç«‹å³ç”ŸæˆæŠ¥å‘Š</button>
                        <button class="btn" onclick="testEmail()">ğŸ“§ æµ‹è¯•é‚®ä»¶å‘é€</button>
                    </div>
                </div>

                <div class="automation-grid">
                    <div class="automation-card">
                        <div class="card-header">
                            <div class="card-icon">ğŸ“…</div>
                            <h3>å®šæ—¶æŠ¥å‘Šç”Ÿæˆ</h3>
                        </div>
                        <p>ç³»ç»Ÿå°†åœ¨æ¯å¤©ä¸Šåˆ9ç‚¹è‡ªåŠ¨ç”Ÿæˆé€‰å“åˆ†ææŠ¥å‘Šï¼Œå¹¶é€šè¿‡é‚®ä»¶å‘é€ç»™æ‚¨ã€‚</p>
                        <div class="status-item">
                            <span>ä»»åŠ¡çŠ¶æ€:</span>
                            <span style="color: #2ecc71;">è¿è¡Œä¸­</span>
                        </div>
                    </div>

                    <div class="automation-card">
                        <div class="card-header">
                            <div class="card-icon">ğŸ“§</div>
                            <h3>é‚®ä»¶é€šçŸ¥ç³»ç»Ÿ</h3>
                        </div>
                        <p>è‡ªåŠ¨å°†é‡è¦åˆ†æç»“æœå’ŒæŠ¥å‘Šå‘é€åˆ°æ‚¨çš„æ³¨å†Œé‚®ç®±ï¼Œç¡®ä¿æ‚¨ä¸é”™è¿‡ä»»ä½•å•†æœºã€‚</p>
                        <div class="status-item">
                            <span>å½“å‰æ¨¡å¼:</span>
                            <span id="mailMode">æ¨¡æ‹Ÿå‘é€</span>
                        </div>
                    </div>

                    <div class="automation-card">
                        <div class="card-header">
                            <div class="card-icon">âš¡</div>
                            <h3>åå°ä»»åŠ¡å¤„ç†</h3>
                        </div>
                        <p>å¤§æ•°æ®åˆ†æå’ŒæŠ¥å‘Šç”Ÿæˆåœ¨åå°å¼‚æ­¥æ‰§è¡Œï¼Œä¸ä¼šå½±å“æ‚¨çš„æ­£å¸¸ä½¿ç”¨ä½“éªŒã€‚</p>
                        <div class="status-item">
                            <span>å·¥ä½œçº¿ç¨‹:</span>
                            <span id="workerCount">4</span>
                        </div>
                    </div>
                </div>

                <div class="system-status">
                    <h3>ğŸ–¥ï¸ ç³»ç»ŸçŠ¶æ€ç›‘æ§</h3>
                    <div id="systemStatus">
                        <!-- ç³»ç»ŸçŠ¶æ€åŠ¨æ€åŠ è½½ -->
                    </div>
                    <div class="task-list" id="taskList">
                        <!-- å®šæ—¶ä»»åŠ¡åˆ—è¡¨åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>

                <!-- äº§å“åˆ—è¡¨éƒ¨åˆ† - å·²æ·»åŠ CSVå¯¼å…¥åŠŸèƒ½ -->
                <div class="reports-section">
                    <h3>ğŸ“¦ äº§å“åˆ—è¡¨</h3>
                    
                    <!-- æ·»åŠ å¯¼å…¥åŠŸèƒ½ -->
                    <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                        <input type="file" id="csvFile" accept=".csv" style="display: none;">
                        <button class="btn btn-success" onclick="document.getElementById('csvFile').click()">
                            ğŸ“ å¯¼å…¥CSVæ–‡ä»¶
                        </button>
                        <button class="btn btn-danger" onclick="clearProducts()">
                            ğŸ—‘ï¸ æ¸…ç©ºäº§å“
                        </button>
                        <button class="btn" onclick="loadProductList()">
                            ğŸ”„ åˆ·æ–°åˆ—è¡¨
                        </button>
                    </div>
                    
                    <div id="importStatus" style="margin-bottom: 10px;"></div>
                    
                    <div id="productList" style="background: white; border-radius: 8px; padding: 20px; margin-top: 15px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">äº§å“åç§°</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">ç±»åˆ«</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">ä»·æ ¼</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">æœˆé”€é‡</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">äº§å“é“¾æ¥</th>
                                </tr>
                            </thead>
                            <tbody id="productTableBody">
                                <!-- äº§å“æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="reports-section">
                    <h3>ğŸ“‹ æœ€è¿‘ç”Ÿæˆçš„æŠ¥å‘Š</h3>
                    <div id="reportsList">
                        <!-- æŠ¥å‘Šåˆ—è¡¨åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>

            <div class="stats-panel">
                <div class="panel-header">
                    <h2>ğŸ“ˆ å®æ—¶æ•°æ®æ¦‚è§ˆ</h2>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalProducts">0</div>
                        <div class="stat-label">æ€»äº§å“æ•°</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-number" id="avgRoi">0%</div>
                        <div class="stat-label">å¹³å‡ROI</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalRevenue">$0</div>
                        <div class="stat-label">æœˆæ”¶ç›Šæ½œåŠ›</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-number" id="highValueCount">0</div>
                        <div class="stat-label">é«˜ä»·å€¼äº§å“</div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <h3>ğŸ† æœ€ä½³è¡¨ç°äº§å“</h3>
                    <div id="topProduct" style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-top: 10px;">
                        åŠ è½½ä¸­...
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <h3>ğŸ“Š æ€§èƒ½æŒ‡æ ‡</h3>
                    <div id="performanceMetrics" style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-top: 10px;">
                        åŠ è½½ä¸­...
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn" onclick="refreshStats()" style="width: 100%;">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSystemStatus();
            loadReports();
            loadStatsOverview();
            loadProductList();
            setInterval(loadSystemStatus, 30000); // æ¯30ç§’åˆ·æ–°ç³»ç»ŸçŠ¶æ€
            setInterval(loadReports, 60000); // æ¯60ç§’åˆ·æ–°æŠ¥å‘Šåˆ—è¡¨
        });

        // åŠ è½½ç³»ç»ŸçŠ¶æ€
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/system/status');
                const data = await response.json();
                
                let statusHtml = `
                    <div class="status-item">
                        <span>ç³»ç»ŸçŠ¶æ€:</span>
                        <span style="color: #2ecc71;">${data.status}</span>
                    </div>
                    <div class="status-item">
                        <span>ä»»åŠ¡è°ƒåº¦å™¨:</span>
                        <span>${data.scheduler_type}</span>
                    </div>
                    <div class="status-item">
                        <span>é‚®ä»¶æœåŠ¡:</span>
                        <span>${data.mail_service}</span>
                    </div>
                    <div class="status-item">
                        <span>æœåŠ¡å™¨æ—¶é—´:</span>
                        <span>${data.server_time}</span>
                    </div>
                `;
                
                document.getElementById('systemStatus').innerHTML = statusHtml;
                
                // æ›´æ–°é‚®ä»¶æ¨¡å¼æ˜¾ç¤º
                document.getElementById('mailMode').textContent = data.mail_service;
                
                // æ˜¾ç¤ºå®šæ—¶ä»»åŠ¡åˆ—è¡¨
                if (data.scheduled_jobs && data.scheduled_jobs.length > 0) {
                    let taskHtml = '<h4>ğŸ“… å®šæ—¶ä»»åŠ¡åˆ—è¡¨</h4>';
                    data.scheduled_jobs.forEach(job => {
                        taskHtml += `
                            <div class="task-item">
                                <span>${job.name || job.id}</span>
                                <span>ä¸‹æ¬¡è¿è¡Œ: ${job.next_run || 'æœªçŸ¥'}</span>
                            </div>
                        `;
                    });
                    document.getElementById('taskList').innerHTML = taskHtml;
                }
                
            } catch (error) {
                console.error('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
            }
        }

        // åŠ è½½æŠ¥å‘Šåˆ—è¡¨
        async function loadReports() {
            try {
                const response = await fetch('/api/reports');
                const data = await response.json();
                
                let reportsHtml = '';
                if (data.reports && data.reports.length > 0) {
                    data.reports.forEach(report => {
                        reportsHtml += `
                            <div class="report-item">
                                <div>
                                    <strong>${report.report_type}æŠ¥å‘Š</strong>
                                    <p>ç”Ÿæˆæ—¶é—´: ${report.generated_at}</p>
                                    <p>${report.summary}</p>
                                </div>
                                <div>
                                    ${report.sent_via_email ? 'ğŸ“§ å·²å‘é€é‚®ä»¶' : 'â³ å¤„ç†ä¸­'}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    reportsHtml = '<p>æš‚æ— æŠ¥å‘Šï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆç¬¬ä¸€ä¸ªæŠ¥å‘Š</p>';
                }
                
                document.getElementById('reportsList').innerHTML = reportsHtml;
                
            } catch (error) {
                console.error('åŠ è½½æŠ¥å‘Šåˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // åŠ è½½æ•°æ®æ¦‚è§ˆ
        async function loadStatsOverview() {
            try {
                const response = await fetch('/api/products/overview');
                const data = await response.json();
                
                if (data.error) {
                    console.error('åŠ è½½æ•°æ®æ¦‚è§ˆå¤±è´¥:', data.error);
                    return;
                }
                
                // æ›´æ–°åŸºç¡€ç»Ÿè®¡
                document.getElementById('totalProducts').textContent = data.basic_stats.total_products;
                document.getElementById('avgRoi').textContent = data.basic_stats.avg_roi + '%';
                document.getElementById('totalRevenue').textContent = '$' + data.basic_stats.total_revenue.toLocaleString();
                document.getElementById('highValueCount').textContent = data.basic_stats.high_value_count;
                
                // æ›´æ–°æœ€ä½³äº§å“
                document.getElementById('topProduct').innerHTML = `
                    <strong>${data.performance_metrics.top_product}</strong>
                    <p style="margin-top: 5px; color: #666;">å½“å‰æœ€ä½³ROIäº§å“</p>
                `;
                
                // æ›´æ–°æ€§èƒ½æŒ‡æ ‡
                document.getElementById('performanceMetrics').innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <strong>åˆ©æ¶¦æ½œåŠ›</strong>
                            <p>$${data.performance_metrics.profit_potential.toFixed(2)}</p>
                        </div>
                        <div>
                            <strong>é”€å”®é€Ÿåº¦</strong>
                            <p>${data.performance_metrics.sales_velocity}</p>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®æ¦‚è§ˆå¤±è´¥:', error);
            }
        }

        // åŠ è½½äº§å“åˆ—è¡¨ - æ–°å¢å‡½æ•°
        async function loadProductList() {
            try {
                const response = await fetch('/api/products');
                const data = await response.json();
                
                let productHtml = '';
                if (data.products && data.products.length > 0) {
                    data.products.forEach(product => {
                        productHtml += `
                            <tr>
                                <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">${product.name}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">${product.category}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">Â¥${product.current_price}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">${product.monthly_sales}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">
                                    ${product.product_url ? 
                                        `<a href="${product.product_url}" target="_blank" style="color: #007bff; text-decoration: none;">ğŸ”— æŸ¥çœ‹äº§å“</a>` : 
                                        '<span style="color: #6c757d;">-</span>'}
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    productHtml = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #6c757d;">æš‚æ— äº§å“æ•°æ®</td></tr>';
                }
                
                document.getElementById('productTableBody').innerHTML = productHtml;
            } catch (error) {
                console.error('åŠ è½½äº§å“åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('productTableBody').innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #dc3545;">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        // CSVæ–‡ä»¶å¯¼å…¥åŠŸèƒ½
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                importCSV(file);
            }
        });

        async function importCSV(file) {
            const statusDiv = document.getElementById('importStatus');
            statusDiv.innerHTML = '<div style="color: #007bff;">ğŸ”„ æ­£åœ¨å¯¼å…¥CSVæ–‡ä»¶...</div>';
            
            const formData = new FormData();
            formData.append('csv_file', file);
            
            try {
                const response = await fetch('/api/import-csv', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = `<div style="color: #28a745;">âœ… ${result.message}</div>`;
                    // å¯¼å…¥æˆåŠŸååˆ·æ–°äº§å“åˆ—è¡¨
                    setTimeout(() => {
                        loadProductList();
                        loadStatsOverview();
                    }, 1000);
                } else {
                    statusDiv.innerHTML = `<div style="color: #dc3545;">âŒ ${result.message}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div style="color: #dc3545;">âŒ å¯¼å…¥å¤±è´¥: ${error}</div>`;
            }
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
            document.getElementById('csvFile').value = '';
        }

        // æ¸…ç©ºäº§å“åŠŸèƒ½
        async function clearProducts() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰äº§å“æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }
            
            try {
                const response = await fetch('/api/clear-products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    // æ¸…ç©ºæˆåŠŸååˆ·æ–°äº§å“åˆ—è¡¨å’Œæ•°æ®æ¦‚è§ˆ
                    loadProductList();
                    loadStatsOverview();
                } else {
                    alert('æ¸…ç©ºå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error);
            }
        }

        // ç”ŸæˆæŠ¥å‘Š
        async function generateReport() {
            try {
                const response = await fetch('/api/generate-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        report_type: 'manual'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('æŠ¥å‘Šç”Ÿæˆä»»åŠ¡å·²å¯åŠ¨ï¼è¯·ç¨åæŸ¥çœ‹æŠ¥å‘Šåˆ—è¡¨ã€‚');
                    setTimeout(loadReports, 2000); // 2ç§’ååˆ·æ–°æŠ¥å‘Šåˆ—è¡¨
                } else {
                    alert('ç”Ÿæˆå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error);
            }
        }

        // æµ‹è¯•é‚®ä»¶å‘é€
        async function testEmail() {
            alert('é‚®ä»¶åŠŸèƒ½æµ‹è¯•ä¸­...ï¼ˆå½“å‰ä½¿ç”¨æ¨¡æ‹Ÿé‚®ä»¶å‘é€ï¼‰');
        }

        // åˆ·æ–°æ•°æ®
        async function refreshStats() {
            await loadStatsOverview();
            await loadReports();
            await loadProductList();
            alert('æ•°æ®å·²åˆ·æ–°ï¼');
        }
    </script>
</body>
</html>
